// admin.js - ARCHIVO COMPLETO FINAL

// Variables globales
let productos = [];
let pedidos = [];
let usuarios = [];
let mesas = [];
let reservas = [];
const API_BASE = 'http://localhost:8080/api';

// ===============================
// INICIALIZACI√ìN
// ===============================
document.addEventListener('DOMContentLoaded', function() {
    verificarAutenticacion();
    configurarNavegacion();
    cargarDashboard();
    actualizarFechaHora();
    setInterval(actualizarFechaHora, 1000);
});

// ===============================
// VERIFICACI√ìN DE AUTENTICACI√ìN
// ===============================
function verificarAutenticacion() {
    console.log('üõ°Ô∏è INICIANDO VERIFICACI√ìN DE ADMIN...');
    
    let userString = localStorage.getItem('currentUser');
    console.log('üì¶ localStorage principal:', userString);
    
    // Si no hay en localStorage, intentar recuperar de URL
    if (!userString) {
        console.log('üîÑ Intentando recuperar desde URL...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const userFromUrl = urlParams.get('user');
        
        if (userFromUrl) {
            try {
                userString = decodeURIComponent(userFromUrl);
                console.log('‚úÖ Datos recuperados desde URL');
                
                // Restaurar en localStorage para futuras visitas
                localStorage.setItem('currentUser', userString);
                
            } catch (error) {
                console.error('üí• Error al decodificar datos de URL:', error);
            }
        }
    }
    
    // LIMPIAR URL inmediatamente (antes de verificar otros backups)
    if (window.location.search) {
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
        console.log('üßπ URL limpiada:', cleanUrl);
    }
    
    // Si a√∫n no hay datos, intentar otros backups
    if (!userString) {
        console.log('üîÑ Intentando otros backups...');
        
        userString = localStorage.getItem('userBackup') || sessionStorage.getItem('currentUser');
        
        if (userString) {
            console.log('‚úÖ Backup encontrado, restaurando...');
            localStorage.setItem('currentUser', userString);
        }
    }
    
    if (!userString) {
        console.error('‚ùå No se encontr√≥ sesi√≥n en ning√∫n lugar');
        alert('Debe iniciar sesi√≥n primero');
        window.location.href = '/login';
        return;
    }
    
    let user;
    try {
        user = JSON.parse(userString);
        console.log('‚úÖ Usuario parseado correctamente:', user);
    } catch (error) {
        console.error('üí• Error al parsear JSON:', error);
        localStorage.clear();
        sessionStorage.clear();
        alert('Sesi√≥n inv√°lida. Debe iniciar sesi√≥n nuevamente');
        window.location.href = '/login';
        return;
    }
    
    // Verificar que tenga los campos necesarios
    if (!user.rol || !user.nombre) {
        console.error('‚ùå DATOS INCOMPLETOS:', { rol: user.rol, nombre: user.nombre });
        alert('Datos de sesi√≥n incompletos. Debe iniciar sesi√≥n nuevamente');
        window.location.href = '/login';
        return;
    }
    
    // Verificar que sea ADMIN
    const esAdmin = user.rol === 'ADMIN' || user.rol === 'Admin' || user.rol?.toUpperCase() === 'ADMIN';
    console.log('üéØ ¬øEs Admin?', esAdmin);
    
    if (!esAdmin) {
        console.error('‚ùå NO ES ADMIN:', { rol: user.rol, esperado: 'ADMIN' });
        alert(`Acceso no autorizado. Solo administradores pueden acceder. Su rol actual: ${user.rol}`);
        
        // Redirigir seg√∫n su rol real
        switch(user.rol?.toUpperCase()) {
            case 'MOZO':
                window.location.href = '/mozo';
                break;
            case 'BARTENDER':
                window.location.href = '/bartender';
                break;
            default:
                window.location.href = '/login';
        }
        return;
    }
    
    // Si lleg√≥ hasta aqu√≠, est√° autorizado
    console.log('‚úÖ ADMIN AUTORIZADO EXITOSAMENTE');
    
    // Actualizar UI
    const userInfoElement = document.getElementById('userInfo');
    if (userInfoElement) {
        const modoLocal = user.esLocal ? ' (Local)' : '';
        userInfoElement.textContent = `Admin: ${user.nombre}${modoLocal}`;
        console.log('‚úÖ UI actualizada');
    }
    
    console.log('üéâ VERIFICACI√ìN COMPLETADA CON √âXITO');
}

// ===============================
// NAVEGACI√ìN
// ===============================
function configurarNavegacion() {
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.dataset.section;
            if (section) {
                cambiarSeccion(section);
            }
        });
    });
}

function cambiarSeccion(section) {
    console.log('üìÑ Cambiando a secci√≥n:', section);
    
    // Actualizar nav activo
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    const activeLink = document.querySelector(`[data-section="${section}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
    }
    
    // Mostrar secci√≥n
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const activeSection = document.getElementById(section);
    if (activeSection) {
        activeSection.classList.add('active');
    }
    
    // Actualizar t√≠tulo
    const titles = {
        dashboard: 'Dashboard',
        productos: 'Gesti√≥n de Productos',
        pedidos: 'Gesti√≥n de Pedidos',
        usuarios: 'Gesti√≥n de Usuarios',
        mesas: 'Gesti√≥n de Mesas',
        reservas: 'Gesti√≥n de Reservas',
        analytics: 'Analytics - Dashboard Externo'
    };
    
    const titleElement = document.getElementById('sectionTitle');
    if (titleElement) {
        titleElement.textContent = titles[section] || section;
    }
    
    // Cargar datos seg√∫n la secci√≥n
// ===============================
// PRODUCTOS - CRUD CON BACKEND REAL
// ===============================

// Cargar productos desde la API real
async function cargarProductos() {
    console.log('üì¶ Cargando productos desde backend...');
    
    try {
        const response = await fetch(`${API_BASE}/productos`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
                // No necesitas Authorization por ahora seg√∫n tu controller
            }
        });
        
        if (response.ok) {
            const apiResponse = await response.json();
            console.log('‚úÖ Respuesta de la API:', apiResponse);
            
            // Tu API devuelve: { success: true, data: [...], message: "..." }
            productos = apiResponse.data || [];
            mostrarProductos();
            console.log(`üìä ${productos.length} productos cargados`);
        } else {
            console.error('‚ùå Error en la respuesta:', response.status);
            mostrarError('Error al cargar productos desde el servidor');
        }
    } catch (error) {
        console.error('‚ùå Error de conexi√≥n:', error);
        mostrarError('Error de conexi√≥n. Verificar que el backend est√© corriendo en localhost:8080');
    }
}

// Mostrar productos en la tabla
function mostrarProductos() {
    const tbody = document.getElementById('productosTabla');
    if (!tbody) {
        console.warn('‚ö†Ô∏è Elemento productosTabla no encontrado');
        return;
    }
    
    if (productos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay productos disponibles</td></tr>';
        return;
    }
    
    tbody.innerHTML = productos.map(producto => `
        <tr>
            <td>${producto.id}</td>
            <td>${producto.nombre}</td>
            <td>${producto.descripcion || 'Sin descripci√≥n'}</td>
            <td>S/${parseFloat(producto.precio).toFixed(2)}</td>
            <td>
                <span class="badge bg-${getCategoriaColor(producto.categoria)}">
                    ${producto.categoria}
                </span>
            </td>
            <td>
                <span class="badge bg-${getStockColor(producto.stock)}">
                    ${producto.stock}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-warning me-1" onclick="editarProducto(${producto.id})" title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="confirmarEliminarProducto(${producto.id})" title="Eliminar">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Crear nuevo producto
async function crearProducto(datosProducto) {
    console.log('üìù Creando producto:', datosProducto);
    
    try {
        const response = await fetch(`${API_BASE}/productos`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(datosProducto)
        });
        
        if (response.ok) {
            const apiResponse = await response.json();
            console.log('‚úÖ Producto creado:', apiResponse);
            
            mostrarMensaje('Producto creado exitosamente');
            cerrarModalProducto();
            cargarProductos(); // Recargar la lista
        } else {
            const errorResponse = await response.json();
            console.error('‚ùå Error al crear:', errorResponse);
            mostrarError(errorResponse.message || 'Error al crear producto');
        }
    } catch (error) {
        console.error('‚ùå Error de conexi√≥n:', error);
        mostrarError('Error de conexi√≥n al crear producto');
    }
}

// Actualizar producto existente
async function actualizarProducto(id, datosProducto) {
    console.log('üìù Actualizando producto:', id, datosProducto);
    
    try {
        const response = await fetch(`${API_BASE}/productos/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(datosProducto)
        });
        
        if (response.ok) {
            const apiResponse = await response.json();
            console.log('‚úÖ Producto actualizado:', apiResponse);
            
            mostrarMensaje('Producto actualizado exitosamente');
            cerrarModalProducto();
            cargarProductos(); // Recargar la lista
        } else {
            const errorResponse = await response.json();
            console.error('‚ùå Error al actualizar:', errorResponse);
            mostrarError(errorResponse.message || 'Error al actualizar producto');
        }
    } catch (error) {
        console.error('‚ùå Error de conexi√≥n:', error);
        mostrarError('Error de conexi√≥n al actualizar producto');
    }
}

// Eliminar producto
async function eliminarProducto(id) {
    console.log('üóëÔ∏è Eliminando producto:', id);
    
    try {
        const response = await fetch(`${API_BASE}/productos/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            console.log('‚úÖ Producto eliminado');
            mostrarMensaje('Producto eliminado exitosamente');
            cargarProductos(); // Recargar la lista
        } else {
            const errorResponse = await response.json();
            console.error('‚ùå Error al eliminar:', errorResponse);
            mostrarError(errorResponse.message || 'Error al eliminar producto');
        }
    } catch (error) {
        console.error('‚ùå Error de conexi√≥n:', error);
        mostrarError('Error de conexi√≥n al eliminar producto');
    }
}

// ===============================
// GESTI√ìN DE MODALES Y FORMULARIOS
// ===============================

function abrirModalProducto(producto = null) {
    const modal = new bootstrap.Modal(document.getElementById('modalProducto'));
    const titulo = document.getElementById('tituloModalProducto');
    
    if (producto) {
        // Modo edici√≥n
        titulo.textContent = 'Editar Producto';
        document.getElementById('productoId').value = producto.id;
        document.getElementById('productoNombre').value = producto.nombre;
        document.getElementById('productoDescripcion').value = producto.descripcion || '';
        document.getElementById('productoPrecio').value = producto.precio;
        document.getElementById('productoStock').value = producto.stock;
        document.getElementById('productoCategoria').value = producto.categoria;
    } else {
        // Modo creaci√≥n
        titulo.textContent = 'Nuevo Producto';
        document.getElementById('formProducto').reset();
        document.getElementById('productoId').value = '';
    }
    
    modal.show();
}

function cerrarModalProducto() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalProducto'));
    if (modal) {
        modal.hide();
    }
}

function guardarProducto() {
    const form = document.getElementById('formProducto');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const datosProducto = {
        nombre: document.getElementById('productoNombre').value.trim(),
        descripcion: document.getElementById('productoDescripcion').value.trim(),
        precio: parseFloat(document.getElementById('productoPrecio').value),
        stock: parseInt(document.getElementById('productoStock').value),
        categoria: document.getElementById('productoCategoria').value,
        disponible: true
    };
    
    const productoId = document.getElementById('productoId').value;
    
    if (productoId) {
        // Actualizar producto existente
        actualizarProducto(productoId, datosProducto);
    } else {
        // Crear nuevo producto
        crearProducto(datosProducto);
    }
}

function editarProducto(id) {
    const producto = productos.find(p => p.id === id);
    if (producto) {
        abrirModalProducto(producto);
    } else {
        mostrarError('Producto no encontrado');
    }
}

function confirmarEliminarProducto(id) {
    const producto = productos.find(p => p.id === id);
    if (!producto) {
        mostrarError('Producto no encontrado');
        return;
    }
    
    if (confirm(`¬øEst√° seguro de eliminar el producto "${producto.nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
        eliminarProducto(id);
    }
}

    // ===============================
    // UTILIDADES PARA PRODUCTOS
    // ===============================

    function getCategoriaColor(categoria) {
        const colores = {
            'BEBIDA': 'primary',
            'COMIDA': 'success', 
            'POSTRE': 'warning',
            'ENTRADA': 'info',
            'SNACK': 'secondary'
        };
        return colores[categoria] || 'secondary';
    }

    function getStockColor(stock) {
        if (stock <= 0) return 'danger';
        if (stock <= 10) return 'warning';
        return 'success';
    }

    // Mejorar las funciones de mensajes
    function mostrarMensaje(mensaje) {
        // Crear toast de Bootstrap
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        const toastElement = document.createElement('div');
        toastElement.className = 'toast';
        toastElement.innerHTML = `
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">√âxito</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">${mensaje}</div>
        `;
        
        toastContainer.appendChild(toastElement);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Limpiar despu√©s de 5 segundos
        setTimeout(() => toastElement.remove(), 5000);
    }

    function mostrarError(error) {
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        const toastElement = document.createElement('div');
        toastElement.className = 'toast';
        toastElement.innerHTML = `
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">${error}</div>
        `;
        
        toastContainer.appendChild(toastElement);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        setTimeout(() => toastElement.remove(), 5000);
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }
}

// ===============================
// DASHBOARD
// ===============================
async function cargarDashboard() {
    console.log('üìä Cargando dashboard...');
    
    try {
        const response = await fetch(`${API_BASE}/dashboard/stats`, {
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            actualizarDashboard(data.data || data);
        } else {
            console.error('Error al cargar dashboard desde backend');
            cargarDashboardLocal(); // Fallback a datos locales
        }
    } catch (error) {
        console.error('Error de conexi√≥n al cargar dashboard:', error);
        cargarDashboardLocal(); // Fallback a datos locales
    }
}

function cargarDashboardLocal() {
    // Datos ficticios para el dashboard
    const statsLocal = {
        totalProductos: 25,
        pedidosHoy: 12,
        ventasHoy: 450.50,
        mesasOcupadas: 6,
        totalClientes: 35
    };
    
    actualizarDashboard(statsLocal);
}

function actualizarDashboard(stats) {
    const elementos = {
        'totalProductos': stats.totalProductos || 0,
        'pedidosHoy': stats.pedidosHoy || 0,
        'ventasHoy': `S/${stats.ventasHoy || 0}`,
        'mesasOcupadas': stats.mesasOcupadas || 0,
        'totalClientes': stats.totalClientes || 0
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.textContent = valor;
        }
    });
}

// ===============================
// PRODUCTOS
// ===============================
async function cargarProductos() {
    console.log('üì¶ Cargando productos...');
    
    try {
        const response = await fetch(`${API_BASE}/productos`, {
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            productos = data.data || data;
            mostrarProductos();
        } else {
            console.error('Error al cargar productos desde backend');
            cargarProductosLocal();
        }
    } catch (error) {
        console.error('Error de conexi√≥n al cargar productos:', error);
        cargarProductosLocal();
    }
}

function cargarProductosLocal() {
    // Productos ficticios para demostraci√≥n
    productos = [
        { id: 1, nombre: 'Pisco Sour', descripcion: 'C√≥ctel peruano tradicional', precio: 25.00, categoria: 'BEBIDA', stock: 20 },
        { id: 2, nombre: 'Ceviche', descripcion: 'Pescado fresco marinado', precio: 35.00, categoria: 'COMIDA', stock: 15 },
        { id: 3, nombre: 'Lomo Saltado', descripcion: 'Plato tradicional peruano', precio: 32.00, categoria: 'COMIDA', stock: 10 },
        { id: 4, nombre: 'Chicha Morada', descripcion: 'Bebida tradicional', precio: 12.00, categoria: 'BEBIDA', stock: 30 }
    ];
    mostrarProductos();
}

function mostrarProductos() {
    const tbody = document.getElementById('productosTabla');
    if (!tbody) return;
    
    tbody.innerHTML = productos.map(producto => `
        <tr>
            <td>${producto.id}</td>
            <td>${producto.nombre}</td>
            <td>${producto.descripcion || ''}</td>
            <td>S/${producto.precio}</td>
            <td>${producto.categoria}</td>
            <td>${producto.stock}</td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editarProducto(${producto.id})">
                    Editar
                </button>
                <button class="btn btn-sm btn-danger" onclick="confirmarEliminarProducto(${producto.id})">
                    Eliminar
                </button>
            </td>
        </tr>
    `).join('');
}

// ===============================
// PEDIDOS
// ===============================
async function cargarPedidos() {
    console.log('üìã Cargando pedidos...');
    // Implementar despu√©s
}

// ===============================
// USUARIOS
// ===============================
async function cargarUsuarios() {
    console.log('üë• Cargando usuarios...');
    // Implementar despu√©s
}

// ===============================
// MESAS
// ===============================
async function cargarMesas() {
    console.log('ü™ë Cargando mesas...');
    // Implementar despu√©s
}

// ===============================
// RESERVAS
// ===============================
async function cargarReservas() {
    console.log('üìÖ Cargando reservas...');
    // Implementar despu√©s
}

// ===============================
// UTILIDADES
// ===============================
function actualizarFechaHora() {
    const ahora = new Date();
    const element = document.getElementById('dateTime');
    if (element) {
        const opciones = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        element.textContent = ahora.toLocaleDateString('es-PE', opciones);
    }
}

function getToken() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    return user ? user.token : '';
}

function mostrarMensaje(mensaje) {
    alert(mensaje); // Implementar toast mejor despu√©s
}

function mostrarError(error) {
    alert('Error: ' + error);
}

// ===============================
// GESTI√ìN DE PRODUCTOS
// ===============================
function abrirModalProducto() {
    // Implementar modal de producto
    console.log('Abriendo modal de producto');
}

function editarProducto(id) {
    console.log('Editando producto:', id);
    // Implementar edici√≥n
}

function confirmarEliminarProducto(id) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
        eliminarProducto(id);
    }
}

function eliminarProducto(id) {
    console.log('Eliminando producto:', id);
    // Implementar eliminaci√≥n
}

function guardarProducto() {
    console.log('Guardando producto');
    // Implementar guardado
}

// ===============================
// OTRAS FUNCIONES DE GESTI√ìN
// ===============================
function abrirModalUsuario() {
    console.log('Abriendo modal de usuario');
}

function abrirModalMesa() {
    console.log('Abriendo modal de mesa');
}

function filtrarPedidos() {
    const filtro = document.getElementById('filtroPedidos').value;
    console.log('Filtrando pedidos por:', filtro);
}

// ===============================
// CERRAR SESI√ìN
// ===============================
function cerrarSesion() {
    console.log('üëã Cerrando sesi√≥n desde admin...');
    
    if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
        // Limpiar todos los storages
        localStorage.clear();
        sessionStorage.clear();
        
        console.log('üßπ Sesi√≥n limpiada');
        
        // Redirigir al login
        window.location.href = '/login';
    }
}

console.log('‚úÖ Admin.js cargado completamente');