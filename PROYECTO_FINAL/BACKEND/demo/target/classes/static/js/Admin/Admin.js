// admin.js - FUNCI√ìN verificarAutenticacion LIMPIA

function verificarAutenticacion() {
    console.log('üõ°Ô∏è INICIANDO VERIFICACI√ìN DE ADMIN...');
    
    let userString = localStorage.getItem('currentUser');
    console.log('üì¶ localStorage principal:', userString);
    
    // Si no hay en localStorage, intentar recuperar de URL
    if (!userString) {
        console.log('üîÑ Intentando recuperar desde URL...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const userFromUrl = urlParams.get('user');
        
        if (userFromUrl) {
            try {
                userString = decodeURIComponent(userFromUrl);
                console.log('‚úÖ Datos recuperados desde URL');
                
                // Restaurar en localStorage para futuras visitas
                localStorage.setItem('currentUser', userString);
                
            } catch (error) {
                console.error('üí• Error al decodificar datos de URL:', error);
            }
        }
    }
    
    // LIMPIAR URL inmediatamente (antes de verificar otros backups)
    if (window.location.search) {
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
        console.log('üßπ URL limpiada:', cleanUrl);
    }
    
    // Si a√∫n no hay datos, intentar otros backups
    if (!userString) {
        console.log('üîÑ Intentando otros backups...');
        
        userString = localStorage.getItem('userBackup') || sessionStorage.getItem('currentUser');
        
        if (userString) {
            console.log('‚úÖ Backup encontrado, restaurando...');
            localStorage.setItem('currentUser', userString);
        }
    }
    
    if (!userString) {
        console.error('‚ùå No se encontr√≥ sesi√≥n en ning√∫n lugar');
        alert('Debe iniciar sesi√≥n primero');
        window.location.href = '/login';
        return;
    }
    
    let user;
    try {
        user = JSON.parse(userString);
        console.log('‚úÖ Usuario parseado correctamente:', user);
    } catch (error) {
        console.error('üí• Error al parsear JSON:', error);
        localStorage.clear();
        sessionStorage.clear();
        alert('Sesi√≥n inv√°lida. Debe iniciar sesi√≥n nuevamente');
        window.location.href = '/login';
        return;
    }
    
    // Verificar que tenga los campos necesarios
    if (!user.rol || !user.nombre) {
        console.error('‚ùå DATOS INCOMPLETOS:', { rol: user.rol, nombre: user.nombre });
        alert('Datos de sesi√≥n incompletos. Debe iniciar sesi√≥n nuevamente');
        window.location.href = '/login';
        return;
    }
    
    // Verificar que sea ADMIN
    const esAdmin = user.rol === 'ADMIN' || user.rol === 'Admin' || user.rol?.toUpperCase() === 'ADMIN';
    console.log('üéØ ¬øEs Admin?', esAdmin);
    
    if (!esAdmin) {
        console.error('‚ùå NO ES ADMIN:', { rol: user.rol, esperado: 'ADMIN' });
        alert(`Acceso no autorizado. Solo administradores pueden acceder. Su rol actual: ${user.rol}`);
        
        // Redirigir seg√∫n su rol real
        switch(user.rol?.toUpperCase()) {
            case 'MOZO':
                window.location.href = '/mozo';
                break;
            case 'BARTENDER':
                window.location.href = '/bartender';
                break;
            default:
                window.location.href = '/login';
        }
        return;
    }
    
    // Si lleg√≥ hasta aqu√≠, est√° autorizado
    console.log('‚úÖ ADMIN AUTORIZADO EXITOSAMENTE');
    
    // Actualizar UI
    const userInfoElement = document.getElementById('userInfo');
    if (userInfoElement) {
        const modoLocal = user.esLocal ? ' (Local)' : '';
        userInfoElement.textContent = `Admin: ${user.nombre}${modoLocal}`;
        console.log('‚úÖ UI actualizada');
    }
    
    console.log('üéâ VERIFICACI√ìN COMPLETADA CON √âXITO');
}