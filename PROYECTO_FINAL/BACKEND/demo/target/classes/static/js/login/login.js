// login.js - Solo funciones de UI, sin validaci√≥n local

console.log('üöÄ CARGANDO LOGIN.JS VERSI√ìN FINAL...');

// Mostrar/Ocultar contrase√±a
const togglePassword = document.getElementById('togglePassword');
const passwordField = document.getElementById('password');

togglePassword.addEventListener('click', () => {
    const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordField.setAttribute('type', type);
    togglePassword.classList.toggle('bi-eye-slash');
});
         
function redirigirSegunRolFinal(rol, userSession) {
    console.log('Ejecutando redirecci√≥n...');
    console.log('- Rol:', rol);
    
    const sessionString = JSON.stringify(userSession);
    
    // Guardar en sessionStorage (espec√≠fico de cada pesta√±a)
    sessionStorage.setItem('currentUser', sessionString);
    
    // Backup en localStorage
    localStorage.setItem('currentUser', sessionString);
    localStorage.setItem('userBackup', sessionString);
    
    console.log('Datos guardados correctamente');
    
    // Determinar URL destino SIN par√°metros
    let targetUrl;
    
    switch(rol?.toUpperCase()) {
        case 'ADMIN':
            targetUrl = '/admin';
            console.log('Redirigiendo a ADMIN');
            break;
        case 'MOZO':
            targetUrl = '/mozo';
            console.log('Redirigiendo a MOZO');
            break;
        case 'BARTENDER':
            targetUrl = '/bartender';
            console.log('Redirigiendo a BARTENDER');
            break;
        default:
            targetUrl = '/index';
            console.log('Redirigiendo a index');
    }
    
    console.log('URL destino:', targetUrl);
    
    // Redirecci√≥n limpia sin par√°metros
    setTimeout(() => {
        window.location.href = targetUrl;
    }, 100);
}

// Funci√≥n wrapper para compatibilidad
function validarLogin() {
    console.log('üìû validarLogin() llamada - ejecutando versi√≥n final');
    return ejecutarLogin();
}

// Funci√≥n wrapper para redirigirSegunRol (por si algo la llama)
function redirigirSegunRol(rol, userSession) {
    console.log('üìû redirigirSegunRol() llamada - ejecutando versi√≥n final');
    return redirigirSegunRolFinal(rol, userSession);
}

// Al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ Login page loaded - versi√≥n final');
    
    // IMPORTANTE: Asegurar que el bot√≥n est√© conectado correctamente
    const loginBtn = document.getElementById('loginBtn');
    if (loginBtn) {
        console.log('‚úÖ Bot√≥n loginBtn encontrado');
        
        // Limpiar cualquier event listener previo
        loginBtn.onclick = ejecutarLogin;
        
        // Tambi√©n manejar Enter en los inputs
        document.getElementById('usuario').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                ejecutarLogin();
            }
        });
        
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                ejecutarLogin();
            }
        });
        
        console.log('‚úÖ Event listeners configurados');
    }
    
    // Verificar sesi√≥n existente
    const userString = localStorage.getItem('currentUser');
    if (userString) {
        try {
            const user = JSON.parse(userString);
            console.log('üë§ Usuario existente encontrado:', user);
            console.log('üîÑ Auto-redirigiendo...');
            redirigirSegunRolFinal(user.rol, user);
        } catch (error) {
            console.error('üí• Error al leer sesi√≥n existente:', error);
            localStorage.clear();
            sessionStorage.clear();
        }
    } else {
        console.log('üÜï No hay sesi√≥n previa - login limpio');
    }
});
async function ejecutarLogin() {
    const usuario = document.getElementById('usuario').value;
    const password = document.getElementById('password').value;
    const loginBtn = document.getElementById('loginBtn');
    const originalText = loginBtn ? loginBtn.textContent : '';

    if (loginBtn) {
        loginBtn.textContent = 'Validando...';
        loginBtn.disabled = true;
    }

    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario, password })
        });

        if (!response.ok) {
            throw new Error('Credenciales incorrectas');
        }

        const userData = await response.json();
        if (userData && userData.rol) {
            redirigirSegunRolFinal(userData.rol, userData);
        } else {
            alert('‚ùå Credenciales incorrectas');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        if (loginBtn) {
            loginBtn.textContent = originalText || 'Iniciar Sesi√≥n';
            loginBtn.disabled = false;
        }
    }
}
// Funci√≥n para cerrar sesi√≥n
function cerrarSesion() {
    console.log('üëã Cerrando sesi√≥n...');
    localStorage.clear();
    sessionStorage.clear();
    window.location.href = '/login';
}

console.log('‚úÖ Login.js versi√≥n final cargado completamente');